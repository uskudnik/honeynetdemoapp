<!doctype html>
<html>
<head>
    <title>demo syslog parser</title>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.0.0/jquery.min.js"></script>
<script type="text/javascript">

sample_syslog_data = [
"May 12 14:13:33 neo mdworker[4257]: Unable to talk to lsboxd",
"May 12 14:13:33 neo sandboxd[4258] ([4257]): mdworker(4257) deny mach-lookup com.apple.ls.boxd",
"May 12 14:13:34 neo kernel[0]: Sandbox: sandboxd(4258) deny mach-lookup com.apple.coresymbolicationd",
"May 12 14:14:34 neo mdworker[4260]: Unable to talk to lsboxd",
"May 12 14:14:34 neo sandboxd[4261] ([4260]): mdworker(4260) deny mach-lookup com.apple.ls.boxd",
"May 12 14:14:34 neo kernel[0]: Sandbox: sandboxd(4261) deny mach-lookup com.apple.coresymbolicationd",
]


var rmax = 15;
var rmin = 10;

var imax = 10;

var identify_components_re = "([A-Z]{1}[a-z]{1,} [0-9]{1,2} [0-9]{2}:[0-9]{2}:[0-9]{2}) ([a-zA-Z]+) ([^:]+):(.+)";

cacheArray = new Array(); cacheSize = 100;

function randomInt(min, max) {
    return Math.floor(Math.random() * (max - min)) + min;
}

function data_generator() {
    return sample_syslog_data[randomInt(0, sample_syslog_data.length)];
}

function syslogFetcher(settings) {
    // $.ajax, remote request, probably best with websockets

    var parser = function(data) {
        var components = data.match(identify_components_re);
        var data_elements = components.slice(1,components.length);
        
        return {
            date: new Date(data_elements[0]),
            user: data_elements[1],
            process: data_elements[2],
            message: data_elements[3],

        };
    }

    var data = parser(data_generator());

    if (typeof settings.repeat === 'number') {
        settings.success(data);
        setTimeout(function(){
            // dbg stuff; lets limit this to 10 interations
            // imax--;
            // if (imax > 0) {
            //     syslogFetcher(settings)
            // }

            syslogFetcher(settings)
        }, settings.repeat); // random: Math.random() * (rmax - rmin) + rmin
    } else {
        settings.success(data);
    }
}

var slf = new syslogFetcher({
    urls: ['one', 'two', 'three'],
    success: show_in_table_fast,
    repeat: 50,
});

function show_in_table(data) {
    var tmpl = function(data) {
        return $("<tr><td>"+data.date+"</td><td>"+data.user+"</td><td>"+data.process+"</td><td>"+data.message+"</td></tr>");
    };

    tmpl(data).insertAfter($("table tr:last"));
}

function show_in_table_fast(data) {
    // Array.push returns length
    console.log(cacheArray)
    if (cacheArray.push(data) > cacheSize) {
        var tmpl_fragment = document.createDocumentFragment();
        while (cacheArray.length) {
            var data = cacheArray.pop();
            var row = document.createElement('tr');
            row.innerHTML = "<td>"+data.date+"</td><td>"+data.user+"</td><td>"+data.process+"</td><td>"+data.message+"</td>";
            tmpl_fragment.appendChild(row);
        }
        // console.log(document.getElementById('table-container').firstChild);
        document.getElementById('table-container').insertBefore(tmpl_fragment, document.getElementById('table-container').firstChild);
    }
    return;
}


// pseudo-code
var socket;

function websockets_connection(URL, callback) {
    socket = new WebSocket(URL);
    socket.send('subscribe-all-log') // Might be used to specify to a server what type of logs should only be used
    socket.onmessage = callback;
}

websockets_connection('http://example.com/test/logs', show_in_table_fast);

</script>
</head>
<body>

<table id='table-container'>
</table>

</body>
</html>